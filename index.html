<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Seismic NFT Card Generator</title>
    <style>
        body {
            background: #0f0c29;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        #canvas-container {
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 25px rgba(138, 43, 226, 0.6);
            background: #000;
        }
        canvas { max-width: 100%; height: auto; display: block; }
        .controls {
            display: flex; flex-direction: column; gap: 10px;
            width: 400px; background: rgba(255, 255, 255, 0.1);
            padding: 20px; border-radius: 10px; backdrop-filter: blur(5px);
        }
        input, button { padding: 12px; border-radius: 5px; border: none; }
        input { background: #1a1a1a; color: white; border: 1px solid #444; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-save { background: #8a2be2; color: white; }
        .btn-download { background: #00c853; color: white; }
    </style>
</head>
<body>

    <h2>SEISMIC CARD GENERATOR</h2>

    <div id="canvas-container">
        <canvas id="pfpCanvas" width="400" height="600"></canvas>
    </div>

    <div class="controls">
        <input type="text" id="userName" placeholder="Nhập tên..." maxlength="20">
        <input type="text" id="magnitude" placeholder="Nhập Magnitude..." value="SEISMIC">
        <input type="file" id="imageInput" accept="image/*">
        <button class="btn-save" id="saveLocal">LƯU TRẠNG THÁI (LOCAL STORAGE)</button>
        <button class="btn-download" id="downloadBtn">TẢI ẢNH & CLEAR DATA</button>
    </div>

    <script>
        const canvas = document.getElementById('pfpCanvas');
        const ctx = canvas.getContext('2d');
        const imageInput = document.getElementById('imageInput');
        const userNameInput = document.getElementById('userName');
        const magInput = document.getElementById('magnitude');

        let userImage = new Image();
        const frameImg = new Image();
        frameImg.crossOrigin = "Anonymous";
        frameImg.src = 'seismic_pfp_original.png';

        frameImg.onload = () => {
            loadFromLocalStorage();
            drawCard();
        };

        imageInput.onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                userImage = new Image();
                userImage.onload = () => drawCard();
                userImage.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        [userNameInput, magInput].forEach(el => el.oninput = drawCard);

        function drawCard() {
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Tọa độ vùng xám đã được tính toán lại cho canvas 400x600
            const targetX = 57;   // (105 / 736) * 400
            const targetY = 38;   // (65 / 1037) * 600
            const targetW = 288;  // (530 / 736) * 400
            const targetH = 365;  // (630 / 1037) * 600

            if (userImage.src) {
                // Thuật toán Resize Cover
                const imgRatio = userImage.width / userImage.height;
                const targetRatio = targetW / targetH;
                let drawW, drawH, offsetX, offsetY;

                if (imgRatio > targetRatio) {
                    drawH = targetH;
                    drawW = targetH * imgRatio;
                    offsetX = targetX - (drawW - targetW) / 2;
                    offsetY = targetY;
                } else {
                    drawW = targetW;
                    drawH = targetW / imgRatio;
                    offsetX = targetX;
                    offsetY = targetY - (drawH - targetH) / 2;
                }

                ctx.save();
                ctx.beginPath();
                ctx.rect(targetX, targetY, targetW, targetH);
                ctx.clip();
                ctx.drawImage(userImage, offsetX, offsetY, drawW, drawH);
                ctx.restore();
            }

            if (frameImg.complete) {
                ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
            }

            // Vẽ Text với tọa độ scale
            ctx.fillStyle = "white";
            ctx.shadowColor = "rgba(255, 255, 255, 0.7)";
            ctx.shadowBlur = 8;
            ctx.font = "bold 20px 'Segoe UI'";
            ctx.fillText(userNameInput.value.toUpperCase(), 90, 460);
            ctx.fillText((magInput.value || "SEISMIC").toUpperCase(), 175, 492);
            ctx.shadowBlur = 0;
        }

        document.getElementById('saveLocal').onclick = () => {
            const appState = {
                name: userNameInput.value,
                magnitude: magInput.value,
                pfpData: userImage.src
            };
            try {
                localStorage.setItem("seismic_pfp_state", JSON.stringify(appState));
                alert("Đã lưu trạng thái!");
            } catch (e) {
                alert("Ảnh quá lớn, hãy dùng ảnh dung lượng thấp hơn.");
            }
        };

        function loadFromLocalStorage() {
            const saved = localStorage.getItem("seismic_pfp_state");
            if (saved) {
                const data = JSON.parse(saved);
                userNameInput.value = data.name;
                magInput.value = data.magnitude;
                if (data.pfpData && data.pfpData.startsWith('data:image')) {
                    userImage = new Image();
                    userImage.onload = () => drawCard();
                    userImage.src = data.pfpData;
                }
            }
        }

        document.getElementById('downloadBtn').onclick = () => {
            try {
                const dataURL = canvas.toDataURL("image/png");
                const link = document.createElement('a');
                link.download = `Seismic_${userNameInput.value || 'NFT'}.png`;
                link.href = dataURL;
                link.click();

                // DOWNLOAD XONG THÌ CLEAR & RESET
                localStorage.removeItem("seismic_pfp_state");
                userImage = new Image();
                userNameInput.value = "";
                magInput.value = "SEISMIC";
                imageInput.value = "";
                
                setTimeout(() => {
                    drawCard();
                    alert("Đã tải về và dọn dẹp bộ nhớ!");
                }, 300);

            } catch (err) {
                alert("Lỗi bảo mật (CORS). Vui lòng chạy qua Live Server.");
            }
        };
    </script>
</body>
</html>
